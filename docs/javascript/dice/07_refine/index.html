<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="robots" content="noindex, nofollow">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>07 Refine | dice</title>
	<link rel="stylesheet" href="./yahtzee.css">

	<!-- DieFace SVGs -->
	<template id="js_dieFace_1">
		<svg role="graphics-symbol img" aria-label="1" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"
			width="24" height="24">
			<rect x="3" y="3" width="42" height="42" ry="3" fill="none" stroke="currentColor" stroke-linecap="round"
				stroke-linejoin="round" stroke-width="2" />
			<circle cx="24" cy="24" r="6" fill="#800000" />
		</svg>
	</template>
	<template id="js_dieFace_2">
		<svg role="graphics-symbol img" aria-label="2" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"
			width="24" height="24">
			<rect x="3" y="3" width="42" height="42" ry="3" fill="none" stroke="currentColor" stroke-linecap="round"
				stroke-linejoin="round" stroke-width="2" />
			<circle cx="13.5" cy="13.5" r="4.5" />
			<circle cx="34.5" cy="34.5" r="4.5" />
		</svg>
	</template>
	<template id="js_dieFace_3">
		<svg role="graphics-symbol img" aria-label="3" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"
			width="24" height="24">
			<rect x="3" y="3" width="42" height="42" ry="3" fill="none" stroke="currentColor" stroke-linecap="round"
				stroke-linejoin="round" stroke-width="2" />
			<circle cx="13.5" cy="13.5" r="4.5" />
			<circle cx="34.5" cy="34.5" r="4.5" />
			<circle cx="24" cy="24" r="4.5" />
		</svg>
	</template>
	<template id="js_dieFace_4">
		<svg role="graphics-symbol img" aria-label="4" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"
			width="24" height="24">
			<rect x="3" y="3" width="42" height="42" ry="3" fill="none" stroke="currentColor" stroke-linecap="round"
				stroke-linejoin="round" stroke-width="2" />
			<circle cx="13.5" cy="13.5" r="4.5" />
			<circle cx="34.5" cy="34.5" r="4.5" />
			<circle cx="13.5" cy="34.5" r="4.5" />
			<circle cx="34.5" cy="13.5" r="4.5" />
		</svg>
	</template>
	<template id="js_dieFace_5">
		<svg role="graphics-symbol img" aria-label="5" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"
			width="24" height="24">
			<rect x="3" y="3" width="42" height="42" ry="3" fill="none" stroke="currentColor" stroke-linecap="round"
				stroke-linejoin="round" stroke-width="2" />
			<circle cx="13.5" cy="13.5" r="4.5" />
			<circle cx="34.5" cy="34.5" r="4.5" />
			<circle cx="24" cy="24" r="4.5" />
			<circle cx="13.5" cy="34.5" r="4.5" />
			<circle cx="34.5" cy="13.5" r="4.5" />
		</svg>
	</template>
	<template id="js_dieFace_6">
		<svg role="graphics-symbol img" aria-label="6" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"
			width="24" height="24">
			<rect x="3" y="3" width="42" height="42" ry="3" fill="none" stroke="currentColor" stroke-linecap="round"
				stroke-linejoin="round" stroke-width="2" />
			<circle cx="13.5" cy="10.5" r="4.5" />
			<circle cx="13.5" cy="37.5" r="4.5" />
			<circle cx="34.5" cy="37.5" r="4.5" />
			<circle cx="34.5" cy="10.5" r="4.5" />
			<circle cx="13.5" cy="24" r="4.5" />
			<circle cx="34.5" cy="24" r="4.5" />
		</svg>
	</template>
</head>

<body class="ly_display">
	<header class="ly_display_header">
		<div class="bl_header">
			<button type="button" class="bl_iconBtn js_btnShowDialog" aria-controls="js_infoDialog">
				<svg role="graphics-symbol img" aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 48 48" width="48" height="48">
					<circle cx="24" cy="10.75" r="3.75"/>
					<rect x="21" y="18" width="6" height="24" ry="0"/>
				</svg>
				<span>インフォ</span>
			</button>
			<dialog class="ly_dialog" id="js_infoDialog">
				<div class="ly_dialog_body">
					<div class="bl_menuHeader">
						<h2 class="bl_menuHeader_title" id="about">
							このページについて
						</h2>
						<button type="button" class="bl_menuHeader_btnIcon js_btnCloseDialog"
							aria-controls="js_infoDialog" aria-describedby="about">
							<svg role="graphics-symbol img" aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 24 24" width="24" height="24">
								<path transform="rotate(45)"
									d="m4.9705-2.0012v4.0023h9.9989v9.9989h4.0023v-9.9989h9.9989v-4.0023h-9.9989v-9.9989h-4.0023v9.9989h-9.9989z" />
							</svg>
							<span>閉じる</span>
						</button>
					</div><!-- /.bl_menuHeader -->
					<figure class="bl_logo">
						<svg version="1.1" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
							aria-label="FUNE Dice Game" viewBox="0 0 156 52" height="52" width="156">
							<path d="m25.844 1.957a24 24 0 0 0-23.566 19.5h1.5312a22.5 22.5 0 0 1 22.035-18 22.5 22.5 0 0 1 22.5 22.5 22.5 22.5 0 0 1-22.5 22.5 22.5 22.5 0 0 1-22.293-19.5h-1.5137a24 24 0 0 0 23.807 21 24 24 0 0 0 24-24 24 24 0 0 0-24-24zm29.049 0.085938v22.258h1.8555v-11.129h20.4v-1.8555h-20.4v-7.418h20.4v-1.8555zm25.67 0v18.547s-4.15e-4 3.7109 3.709 3.7109h14.838s3.709-0.0015 3.709-3.7109v-18.547h-1.8555v18.547s1e-3 1.8555-1.8535 1.8555h-14.838s-1.8555-7.68e-4 -1.8555-1.8555v-18.547zm25.668 0v22.258h1.8555v-20.234l18.547 20.234h1.8555v-22.258h-1.8555v20.234l-18.547-20.234zm25.67 0v22.258h22.256v-1.8555h-20.402v-9.2734h20.402v-1.8555h-20.402v-7.418h20.402v-1.8555zm-106.06 2.9141a21 21 0 0 0-20.893 19.5h-3a24 24 0 0 0-0.10742 1.5h3a21 21 0 0 0 6.1719 14.828l1.0586-1.0586a19.5 19.5 0 0 1-5.7305-13.77h18v19.389a19.5 19.5 0 0 1-3.8496-0.66211l-0.41211 1.4414a21 21 0 0 0 5.7617 0.83203v-36h-12.418a19.5 19.5 0 0 1 12.418-4.5zm3 0.22461v17.775h1.5v-17.51a21 21 0 0 0-1.5-0.26562zm6.9551 2.2871-0.71094 1.3223a19.5 19.5 0 0 1 10.008 14.166h1.5117a21 21 0 0 0-10.809-15.488zm-23.961 4.9883h12.506v12h-17.893a19.5 19.5 0 0 1 5.3867-12zm3.5059 4.5c-0.831 0-1.5 0.669-1.5 1.5v1.5c0 0.831 0.669 1.5 1.5 1.5h1.5c0.831 0 1.5-0.669 1.5-1.5v-1.5c0-0.831-0.669-1.5-1.5-1.5zm13.5 10.5v19.277a21 21 0 0 0 17.934-19.277h-1.5039zm-13.5 1.5c-0.4155 0-0.75 0.3345-0.75 0.75v6c0 0.4155 0.3345 0.75 0.75 0.75h1.5c0.4155 0 0.75-0.3345 0.75-0.75v-6c0-0.4155-0.3345-0.75-0.75-0.75zm15 0h14.701a19.5 19.5 0 0 1-14.701 15.908zm20.785 0a25.5 25.5 0 0 1-0.23438 1.5h103.26v-1.5zm3.7637 5.877v15.209h10.139c1.2674 0 5.0703-2.5339 5.0703-7.6035 0-5.0696-3.8029-7.6055-5.0703-7.6055zm49.582 0s-2.5352 3.38e-4 -2.5352 2.5352v10.141s3.5e-4 2.5332 2.5352 2.5332h10.139s2.5352 0.0016 2.5352-2.5332v-3.8027h-6.3379v1.2676h5.0703v2.5352s-1.7e-4 1.2656-1.2676 1.2656h-10.139s-1.2676 0.0018-1.2676-1.2656v-10.141s1.7e-4 -1.2676 1.2676-1.2676h10.139s1.2676 1.7e-4 1.2676 1.2676v2.5352h1.2676v-2.5352s-3.4e-4 -2.5352-2.5352-2.5352zm-48.314 1.2676h8.4492c1.0562 0 4.2246 2.1132 4.2246 6.3379 0 4.2247-3.1684 6.3359-4.2246 6.3359h-8.4492zm16.637 1.2676a0.6337 0.6337 0 0 0-0.63281 0.63476 0.6337 0.6337 0 0 0 0.63281 0.63281 0.6337 0.6337 0 0 0 0.63477-0.63281 0.6337 0.6337 0 0 0-0.63477-0.63476zm-0.63281 2.5352v10.139h1.2676v-10.139zm5.8633 0s-2.5352 3.37e-4 -2.5352 2.5352v5.0703s3.37e-4 2.5332 2.5352 2.5332h7.6035v-1.2676h-7.6035s-1.2676 0.0018-1.2676-1.2656v-5.0703s1.68e-4 -1.2676 1.2676-1.2676h7.6035v-1.2676zm12.201 0s-2.5352 3.4e-4 -2.5352 2.5352v5.0703s3.4e-4 2.5332 2.5352 2.5332h5.0703s2.5332 0.0016 2.5332-2.5332h-1.2676s0.0018 1.2656-1.2656 1.2656h-5.0703s-1.2676 0.0018-1.2676-1.2656v-2.5352h8.8711v-2.5352s0.0016-2.5352-2.5332-2.5352zm31.229 0s-2.5352 3.43e-4 -2.5352 2.5352v5.0703s3.4e-4 2.5332 2.5352 2.5332h1.2676s3.221-6.78e-4 5.0703-2.2969v2.2969h1.2676v-7.6035s-3.5e-4 -2.5352-2.5352-2.5352zm9.3789 0v10.139h1.2676v-7.6035s1.6e-4 -1.2676 1.2676-1.2676h1.2676s1.2676 1.71e-4 1.2676 1.2676v7.6035h1.2676v-7.6035s1.7e-4 -1.2676 1.2676-1.2676h1.2656s1.2676 1.71e-4 1.2676 1.2676v7.6035h1.2676v-7.6035s-3.5e-4 -2.5352-2.5352-2.5352h-1.2656s-1.1556 0.0016-1.9062 0.78125c-0.37242-0.4355-0.96125-0.78125-1.8965-0.78125h-1.2676s-0.63386-4.47e-4 -1.2676 0.31641v-0.31641zm15.717 0s-2.5352 3.4e-4 -2.5352 2.5352v5.0703s3.3e-4 2.5332 2.5352 2.5332h5.0684s2.5352 0.0016 2.5352-2.5332h-1.2676s-1.7e-4 1.2656-1.2676 1.2656h-5.0684s-1.2676 0.0018-1.2676-1.2656v-2.5352h8.8711v-2.5352s-3.5e-4 -2.5352-2.5352-2.5352zm-56.324 1.2676h5.0703c1.2674 0 1.2656 1.2676 1.2656 1.2676v1.2676h-7.6035v-1.2676c0-1.2674 1.2676-1.2676 1.2676-1.2676zm31.229 0h5.0703c1.2674 0 1.2676 1.2676 1.2676 1.2676v1.2676c0 5.0696-5.0703 5.0684-5.0703 5.0684h-1.2676c-1.2674 0-1.2676-1.2656-1.2676-1.2656v-5.0703c0-1.2674 1.2676-1.2676 1.2676-1.2676zm25.096 0h5.0684c1.2674 0 1.2676 1.2676 1.2676 1.2676v1.2676h-7.6035v-1.2676c0-1.2674 1.2676-1.2676 1.2676-1.2676z"/>
						</svg>
					</figure>
					<h3 class="el_heading_lv3">概要</h3>
					<p>
						このページでは、Yacht ライクのダイスゲームを遊べます。
					</p>
					<h3 class="el_heading_lv3">基本的な流れ</h3>
					<p>
						5つのダイスを使って役を作り、12(+1) の役の合計点を競います。
						ターンの初めにダイスを振り、2回まで振り直すことができます。ダイスを振り直す際、任意のダイスにロックを掛けることができます。
					</p>
					<h3 class="el_heading_lv3">役の一覧</h3>
					<p>
						役は12と1つのボーナスで構成されています。
					</p>
					<h4 class="el_heading_lv4">アッパーセクション</h4>
					<h5 class="el_heading_lv5">エース</h5>
				</div><!-- /.ly_dialog_body -->
			</dialog><!-- /.ly_dialog -->
			<div class="bl_select">
				<select class="bl_header_select" name="js_decision_strategy" id="js_decision_strategy">
					<!-- 中身はJS側で管理 -->
				</select>
			</div><!-- /.bbl_select -->
			<button type="button" id="js_reset" class="bl_iconBtn" onclick="reloadWithQuery()">
				<svg role="graphics-symbol img" aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 48 48" width="48" height="48">
					<path
						d="m24 5.25a21 21 0 0 0-21 21 21 21 0 0 0 4.7812 13.219l-3.2812 3.2812h9v-9l-3.6016 3.6016a18 18 0 0 1-3.8984-11.102 18 18 0 0 1 18-18 18 18 0 0 1 18 18 18 18 0 0 1-5.3047 12.695l2.1172 2.1172a21 21 0 0 0 6.1875-14.812 21 21 0 0 0-21-21z"
						stroke-linecap="round" stroke-linejoin="round" />
				</svg>
				<span>リセット</span>
			</button>
		</div><!-- /.bl_header -->
	</header><!-- /.ly_display_header -->

	<main class="ly_display_main">
		<ul class="bl_result">
			<li class="bl_result_unit">
				<button type="button" class="bl_iconBtn bl_iconBtn__horizontal js_btnShowDialog"
					aria-controls="js_scoreDialog_player" aria-describedby="player_name">
					<span class="js_player_totalScore"></span>
					<small class="hp_srOnly">点 詳細</small>
					<svg version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
						<circle cx="18" cy="18" r="15" fill="none" stroke="currentColor" stroke-linecap="round"
							stroke-linejoin="round" stroke-width="2" />
						<path d="m27 30 1.5 1.5 1.5 4.5 9 9 6-6-9-9-4.5-1.5-1.5-1.5z" />
					</svg>
				</button>
				<span class="bl_result_unitName js_player_name" id="player_name"></span>
				<!-- /.bl_result_unitName -->
				<dialog class="ly_dialog" id="js_scoreDialog_player">
					<div class="ly_dialog_body">
						<div class="bl_menuHeader">
							<h2 class="bl_menuHeader_title" id="result_player">
								<span class="js_player_name"></span>のスコア
							</h2>
							<button type="button" class="bl_menuHeader_btnIcon js_btnCloseDialog" aria-controls="js_scoreDialog_player"
								aria-describedby="result_player">
								<svg role="graphics-symbol img" aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 24 24" width="24" height="24">
									<path transform="rotate(45)"
										d="m4.9705-2.0012v4.0023h9.9989v9.9989h4.0023v-9.9989h9.9989v-4.0023h-9.9989v-9.9989h-4.0023v9.9989h-9.9989z" />
								</svg>
								<span>閉じる</span>
							</button>
						</div><!-- /.bl_menuHeader -->
						<div class="js_player_score"></div><!-- /.js_player_score -->
					</div><!-- /.ly_dialog_body -->
				</dialog><!-- /.ly_dialog -->
			</li><!-- /.bl_result_unit -->
			<li class="bl_result_unit">
				<button type="button" class="bl_iconBtn bl_iconBtn__horizontal js_btnShowDialog"
					aria-controls="js_scoreDialog_enemy" aria-describedby="enemy_name">
					<span class="js_enemy_totalScore"></span>
					<small class="hp_srOnly">点 詳細</small>
					<svg version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
						<circle cx="18" cy="18" r="15" fill="none" stroke="currentColor" stroke-linecap="round"
							stroke-linejoin="round" stroke-width="2" />
						<path d="m27 30 1.5 1.5 1.5 4.5 9 9 6-6-9-9-4.5-1.5-1.5-1.5z" />
					</svg>
				</button>
				<span class="bl_result_unitName js_enemy_name" id="enemy_name"></span>
				<!-- /.bl_result_unitName -->
				<dialog class="ly_dialog" id="js_scoreDialog_enemy">
					<div class="ly_dialog_body">
						<div class="bl_menuHeader">
							<h2 class="bl_menuHeader_title" id="result_enemy">
								<span class="js_enemy_name"></span>のスコア
							</h2>
							<button type="button" class="bl_menuHeader_btnIcon js_btnCloseDialog" aria-controls="js_scoreDialog_enemy"
								aria-describedby="result_enemy">
								<svg role="graphics-symbol img" aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 24 24" width="24" height="24">
									<path transform="rotate(45)"
										d="m4.9705-2.0012v4.0023h9.9989v9.9989h4.0023v-9.9989h9.9989v-4.0023h-9.9989v-9.9989h-4.0023v9.9989h-9.9989z" />
								</svg>
								<span>閉じる</span>
							</button>
						</div><!-- /.bl_menuHeader -->
						<div class="js_enemy_score"></div><!-- /.js_enemy_score -->
					</div><!-- /.ly_dialog_body -->
				</dialog><!-- /.ly_dialog -->
			</li><!-- /.bl_result_unit -->
		</ul><!-- /.bl_result -->
	</main><!-- /.ly_display_main -->

	<footer class="ly_display_footer">
		<form action="#" class="ly_footer" id="js_controller">
			<div class="ly_footer_diceContainer">
				<div id="js_dice" class="bl_dice_wrapper">
				</div><!-- /.js_dice_wrapper -->
			</div><!-- /.ly_footer_diceContainer -->
			<div class="ly_footer_rollBtn">
				<button type="button" id="js_roll" class="el_btn el_btn__secondary">
					振る(<span id="js_roll_remain">1</span>)
				</button><!-- /.el_btn.el_btn_roll -->
			</div><!-- /.ly_footer_rollBtn -->
			<div class="ly_footer_select">
				<div class="bl_select">
					<select name="js_decision_combination" id="js_decision_combination">
					</select>
				</div>
				<!-- /.bl_select -->
			</div><!-- /.ly_footer_select -->
			<div class="ly_footer_submit">
				<button type="submit" id="js_btn_submit" class="el_btn el_btn__primary" aria-label="決定">
					決定
				</button>
			</div><!-- /.ly_footer_submit -->
			<!-- /.el_btn.el_btn_submit -->
		</form><!-- /.ly_footer -->
	</footer><!-- /.ly_display_footer -->
	<dialog class="ly_dialog" id="js_resultDialog">
		<div class="ly_dialog_body">
			<div class="bl_menuHeader">
				<h2 class="bl_menuHeader_title" id="result_player">ゲーム結果</h2>
				<button type="button" class="bl_menuHeader_btnIcon"
					aria-describedby="result_player" onclick="reloadWithQuery()">
					<svg role="graphics-symbol img" aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg"
						viewBox="0 0 48 48" width="48" height="48">
						<path
							d="m24 5.25a21 21 0 0 0-21 21 21 21 0 0 0 4.7812 13.219l-3.2812 3.2812h9v-9l-3.6016 3.6016a18 18 0 0 1-3.8984-11.102 18 18 0 0 1 18-18 18 18 0 0 1 18 18 18 18 0 0 1-5.3047 12.695l2.1172 2.1172a21 21 0 0 0 6.1875-14.812 21 21 0 0 0-21-21z"
							stroke-linecap="round" stroke-linejoin="round" />
					</svg>
					<span style="font-size: 0.5em;">リセット</span>
				</button>
			</div><!-- /.bl_menuHeader -->
			<h3 class="el_heading_lv2">
				<span class="js_player_name"></span>のスコア：
				<span class="js_player_totalScore"></span>
			</h3>
			<div class="js_player_score"></div>
			<!-- /.js_player_score -->
			<h3 class="el_heading_lv2">
				<span class="js_enemy_name"></span>のスコア：
				<span class="js_enemy_totalScore"></span>
			</h3>
			<div class="js_enemy_score"></div>
			<!-- /.js_enemy_score -->
		</div><!-- /.ly_dialog_body -->
	</dialog>

	<script src="./yahzee-rev2.js"></script>
	<script>
		const wait = async (ms) => new Promise(resolve => setTimeout(resolve, ms));

    function findNullIndices(arr) {
      let indices = [];
      arr.forEach((element, index) => {
          if (element === null) {
              indices.push(index);
          }
      });
      return indices;
    }

		async function roleEffect(element, className, ms = 500){
			element.classList.add(className);
			await wait(ms);
			element.classList.remove(className);
		}

		/**
		 * テーブルスタイルを enum 風に管理
		 */
		const TABLE_STYLE = Object.freeze({
			none: 0,							// ベース
			horizontal: 1,				// 水平（行方向に重きを置く表）
			vertical: 2,					// 垂直（列方向に重きを置く表）
			cross: 3,							// クロス（行列組み合わせた表）
			noneWide: 4,					// ベース＋ワイド（列数が多めで、横方向へスクロールするスタイルの幅が広め）
			horizontalWide: 5,
			verticalWide: 6,
			crossWide: 7,
			noneWideEx: 8,				// ベース＋EXワイド（列数が更に多く、ワイドよりも更に広め）
			horizontalWideEx: 9,
			verticalWideEx: 10,
			crossWideEx: 11,
		});

		function createTable(dataArray, tableStyle=0) {
			const styleWidth = Math.floor(tableStyle / 4);
			const styleDirection = tableStyle % 4;

			// テーブルのラップ要素 div の生成
			const tableWrapper = document.createElement('div');
			let classes = ['bl_table'];
			switch (styleDirection) {
				case 0:
					break;
				case 1:
					classes.push('bl_table__horizontal');
					break;
				case 2:
					classes.push('bl_table__vertical');
					break;
				case 3:
					classes.push('bl_table__cross');
					break;
			}
			switch (styleWidth) {
				case 0:
					break;
				case 1:
					classes.push('bl_table__wide');
					break;
				case 2:
					classes.push('bl_table__exWide');
					break;
			}
			tableWrapper.classList.add(...classes);

			const table = document.createElement('table');
			tableWrapper.appendChild(table);

			// ヘッダー部を作成
			const tableHeaderRow = table.createTHead().insertRow();
			const arrayHeader = dataArray.shift();
			let isFirstCell = true;	// クロス表の表側頭で scope をつけないためのもの
			for(const cell of arrayHeader){
				const th = document.createElement('th');
				th.textContent = cell;

				// 表形式が 垂直 または クロスかつ表側頭セル以外の場合、スコープ付与
				if((styleDirection === 2) || (styleDirection === 3 && isFirstCell === false)) {
					th.scope = 'col';
				}
				tableHeaderRow.appendChild(th);
				isFirstCell = false;
			}

			// ボディ部を作成
			const tableBody = table.createTBody();
			for (const arrayRow of dataArray) {
				const row = tableBody.insertRow();

				// 初回のみ th 要素
				const thCell = arrayRow.shift();
				const th = document.createElement('th');
				th.textContent = thCell;
				if(styleDirection === 1 || styleDirection === 3) {
					th.scope = 'row';
				}
				row.appendChild(th);

				// 2列目以降は td 要素
				for(const tdCell of arrayRow){
					const cell = row.insertCell();
					cell.textContent = tdCell;
				}
			}

			// テーブル要素を格納した div.bl_table 要素を返す
			return tableWrapper;
		}
		// Template
		const TEMP_DIEFACES = Object.freeze({
			1: document.querySelector('#js_dieFace_1'),
			2: document.querySelector('#js_dieFace_2'),
			3: document.querySelector('#js_dieFace_3'),
			4: document.querySelector('#js_dieFace_4'),
			5: document.querySelector('#js_dieFace_5'),
			6: document.querySelector('#js_dieFace_6'),
		});

		let url = new URL(document.location);
		let urlParams = url.searchParams;
		const enemyID = parseInt(urlParams.get('enemy_id')) || 0;
		const enemyList = ['検証用ダミー', 'CPU弱'];
		const selEnemy = document.querySelector('#js_decision_strategy');
		selEnemy.innerHTML = '';
		for (let i = 0; i < enemyList.length; i++){
			const opt = document.createElement('option');
			opt.value = i;
			opt.text = enemyList[i];
			if (enemyID === i) opt.selected = true;
			selEnemy.add(opt, selEnemy.options.item(i));
		}

		// クエリ付きでリロードする関数（CPU変更や、ゲーム終了時に使用）
		function reloadWithQuery(){
			urlParams.set('enemy_id', selEnemy.value);
			window.location.href = url.href;
		}

		// Enemyの行動データ
		let enemyScore = [];
		switch(enemyID){
			case 1:
				for (let i = 0; i <= 12; i++) {
					enemyScore.push([i, i]);
				}
				break;
			default:	// 不明、もしくは0
				for (let i = 0; i <= 12; i++) {
					enemyScore.push([i, 0]);
				}
		}


		class Controller {
			constructor(player, form){
				this.remainTime = 3;
				this.player = player;
				this.form = form;

				// form内要素の定義
				this.rollBtn = form.querySelector('#js_roll');
				this.rollBtnRemain = form.querySelector('#js_roll_remain');	// span;
				this.diceContainer = form.querySelector('#js_dice');	// div;
				this.select = form.querySelector('#js_decision_combination');

				// [dieFace, lock] の形で、5つのダイスを状態管理
				this.diceStatus = [[1, false], [1, false], [1, false], [1, false], [1, false]];
				this.dices = [];
				for(let i = 0; i < 5; i++){
					this.dices[i] = {};

					// Label
					const diceElement = document.createElement('label');
					diceElement.classList.add('bl_dice');
					this.dices[i].label = diceElement;

					// CheckBox
					const chkbox = document.createElement('input');
					chkbox.type = 'checkbox';
					chkbox.checked = this.diceStatus[i][1];
					chkbox.name = 'dice' + i;
					chkbox.classList.add('bl_dice_chkbox');
					this.dices[i].chkbox = chkbox;

					// Append Container node(ChkBox, SVG -> diceContainer)
					this.dices[i].label.appendChild(this.dices[i].chkbox);
					this.dices[i].label.appendChild(TEMP_DIEFACES[this.diceStatus[i][0]].content.cloneNode(true));
					this.diceContainer.appendChild(this.dices[i].label);
				}

				// 役情報の格納（確定済みの役を除外した上での [index, point] の形）
				this.combinations = [];

				// Submit 時のイベントハンドラ関数（Playerのスコアを決定し、Submitイベントを除去）
				this.decide = (event) => {
					event.preventDefault();
					this.diceContainer.innerHTML = '';  // ChildNode がなくなるまで removeChild する必要はなし
          const scoreIndex = parseInt(this.select.value) || 0;
					this.player.setScore(this.combinations[scoreIndex][0], this.combinations[scoreIndex][1]);
					this.form.removeEventListener('submit', this.decide);
				}

				// Submitボタン押下、またはフォーム内エンターでのサブミット処理
				this.form.addEventListener('submit', this.decide);
				this.rollBtn.addEventListener('click',()=>{
					this.roll();
				});

				this.roll();
			}

			roll(){
				if(this.remainTime > 0){
					this.remainTime -= 1;
					let newStatus = [];

					// Lock 状態を取得し、diceStatus を更新。その後ロール処理
					for(let i = 0; i < 5; i++){
						roleEffect(this.dices[i].label, 'js_anime_roll');
						this.diceStatus[i][1] = this.dices[i].chkbox.checked;
						if(this.diceStatus[i][1] === true){
							// Lock 状態ならそのまま移行
							newStatus.push(this.diceStatus[i]);
						} else {
							// Unlock 状態なら、ダイスを振って登録
							newStatus.push([Math.floor(Math.random() * 6) + 1, false]);
						}
					}

					// ソートしたものを登録
					this.diceStatus = newStatus.sort((a, b) => a[0] - b[0]);

					// ダイス値からのポイント判定
					let dieFaces = '';
					for(let i = 0; i < 5;i++) dieFaces += this.diceStatus[i][0].toString();
					const points = calcCombinations(dieFaces);

					// 確定済みを除去した、選択可能な役情報の作成（select用に、高得点順にソート）
					const nulls = findNullIndices(this.player.score.slice(0, -1));
					let combinations = []
					for(let i of nulls) combinations.push([i, points[i]]);
					this.combinations = combinations.sort((a, b) => b[1] - a[1]);;

					this.refreshControl();
				}
			}
			refreshControl(){
				// ロールボタンの更新（残回数0なら disabled 化）
				this.rollBtnRemain.textContent = this.remainTime;
				this.rollBtn.disabled = (this.remainTime === 0);

				// ダイス更新
				for(let i = 0; i < 5; i++){
					this.dices[i].chkbox.checked = this.diceStatus[i][1];
					const newSvg = TEMP_DIEFACES[this.diceStatus[i][0]].content.cloneNode(true);
					this.dices[i].label.replaceChild(newSvg, this.dices[i].label.querySelector('svg'));
				}

				// 役のセレクト内容を更新
				this.select.innerHTML = '';
        const length = this.combinations.length;
				for(let i = 0; i < length; i++){
          // value に this.combination へのインデックスを持つ、オプション要素
					const opt = document.createElement('option');
					opt.value = i;
					opt.text = `${SCORE_NAMES[this.combinations[i][0]]}：${this.combinations[i][1]}`;
					this.select.add(opt, this.select.options.item(i));
				}
			}
		}

		const form = document.querySelector('#js_controller');
		const pName = 'プレイヤー1';
		const p1 = new Player(pName);
		const e1 = new Enemy(enemyList[enemyID], enemyScore);
		const gm = new GameMaster(p1, e1);

		let ctrl = new Controller(p1, form);


		const resultDialog = document.querySelector('#js_resultDialog');

		const playerNames = document.querySelectorAll('.js_player_name');
		for(const ele of playerNames) ele.textContent = pName;

		const enemyNames = document.querySelectorAll('.js_enemy_name');
		for(const ele of enemyNames) ele.textContent = enemyList[enemyID];

		const playerScoreTable = document.querySelectorAll('.js_player_score');
		const playerTotalScore = document.querySelectorAll('.js_player_totalScore');
		const enemyScoreTable = document.querySelectorAll('.js_enemy_score');
		const enemyTotalScore = document.querySelectorAll('.js_enemy_totalScore');

		function updateScore(){
			for(const ele of playerTotalScore){
				ele.textContent = p1.totalScore;
			}
			for(const ele of enemyTotalScore){
				ele.textContent = e1.totalScore;
			}
			const scoreNames = Object.values(SCORE_NAMES);
			for(const ele of playerScoreTable){
				ele.innerHTML = '';
				let pTable = [['点数', '役']];
				const p1score = p1.score;
				for(i=0; i<14; i++) pTable.push([p1score[i], scoreNames[i]]);
				const pTableElement = createTable(pTable,2);
				ele.append(pTableElement);
			}
			for(const ele of enemyScoreTable){
				ele.innerHTML = '';
				let eTable = [['点数', '役']];
				const e1score = e1.score;
				for(i=0; i<14; i++) eTable.push([e1score[i], scoreNames[i]]);
				const eTableElement = createTable(eTable,2);
				ele.appendChild(eTableElement);
			};
		}
		updateScore();

		document.addEventListener('handover', (e) => {
			updateScore();
			let isPlayer = e.detail.isPlayer;
			if (isPlayer) {
				gm.update();
				if (!gm.isFinished) {
					console.log(`${e1.name} のターンです。`);
					e1.setDummyData();
					ctrl = new Controller(p1, form);
				} else {
					resultDialog.showModal();
				}
			} else {
				gm.update();
				if (!gm.isFinished) {
					console.log(`${p1.name} のターンです。`);
				} else {
					resultDialog.showModal();
				}
			}
		})

	</script>
</body><!-- /.ly_display -->

</html>
